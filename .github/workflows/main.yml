name: Deploy to Cloud Server

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“ Create .env file for secrets
        # Creates the .env file locally on the GitHub Actions runner
        run: |
          echo "DB_USER=${{ secrets.DB_USER }}" > .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
          echo "DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}" >> .env
          echo "WORK_ENV=${{ secrets.WORK_ENV }}" >> .env

      - name: ðŸ”‘ Set up SSH connection
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸš€ Deploy via SCP and SSH 
        env:
          # Define your connection details as environment variables for the script
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: 24700 # Explicitly define the port
          DEPLOY_PATH: /home/${{ secrets.SSH_USER }}/ConnectBakeryIS # Corrected DEPLOY_PATH 
        run: |
          # 1. Ensure the deployment path exists on the server
          echo "Checking deployment path on server..."
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"

          # 2. Copy the .env file explicitly
          echo "Copying .env file explicitly to server..."
          scp -P ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ./.env ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/.env

          # 3. Copy all NON-HIDDEN files (your app code, docker-compose.yml, init.sql, etc.)
          echo "Copying application code and configs to server..."
          scp -r -P ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ./* ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}

          # 4. Run the Docker commands on the server via SSH
          echo "Executing Docker commands on server..."
          ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            
            cd ${{ env.DEPLOY_PATH }}
            docker compose down --remove-orphans
            echo "Building and restarting Docker services..."
            docker compose up -d --build --force-recreate 
            
            echo "Deployment complete!"
          EOF
